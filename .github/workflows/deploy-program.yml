name: Build and Deploy Solana Program

on:
  push:
    branches: [ main ]
    paths:
      - 'programs/**'
      - 'Cargo.toml'
      - 'Anchor.toml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Remove Cargo.lock files
        run: |
          # Remove all Cargo.lock files immediately after checkout
          find . -name "Cargo.lock" -type f -delete
          echo "Removed all Cargo.lock files"
          
          # Also remove from programs directory specifically
          rm -f Cargo.lock
          rm -f programs/*/Cargo.lock
          rm -f programs/clash-royale-escrow/Cargo.lock
          
          # Verify they're gone
          if find . -name "Cargo.lock" -type f | grep -q .; then
            echo "Warning: Some Cargo.lock files still exist"
            find . -name "Cargo.lock" -type f
          else
            echo "âœ“ All Cargo.lock files removed"
          fi
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Solana CLI
        run: |
          # Use direct binary download method (more reliable)
          SOLANA_VERSION="1.18.26"
          mkdir -p $HOME/.local/share/solana/install/active_release/bin
          
          # Download Solana release from GitHub (more reliable than release.solana.com)
          curl -L "https://github.com/solana-labs/solana/releases/download/v${SOLANA_VERSION}/solana-release-x86_64-unknown-linux-gnu.tar.bz2" \
            -o /tmp/solana.tar.bz2 || {
            echo "Failed to download, trying latest release..."
            curl -L "https://github.com/solana-labs/solana/releases/latest/download/solana-release-x86_64-unknown-linux-gnu.tar.bz2" \
              -o /tmp/solana.tar.bz2
          }
          
          # Extract and install
          tar -xjf /tmp/solana.tar.bz2 -C /tmp
          cp -r /tmp/solana-release/* $HOME/.local/share/solana/install/active_release/
          
          # Add to PATH
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          
          # Verify installation
          solana --version
          solana-install --version
      
      - name: Install Anchor
        run: |
          # Install avm (Anchor Version Manager) first
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          
          # Add cargo bin to PATH for avm
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          
          # Install Anchor 0.32.1 using avm
          avm install 0.32.1
          avm use 0.32.1
          
          # Add Anchor to PATH
          export PATH="$HOME/.avm/bin:$PATH"
          echo "$HOME/.avm/bin" >> $GITHUB_PATH
          
          # Verify installation and version
          anchor --version
          echo "Anchor version: $(anchor --version)"
      
      - name: Setup Solana CLI
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana config set --url devnet
          solana-keygen new --no-bip39-passphrase -o ~/.config/solana/id.json || true
      
      - name: Airdrop SOL (Devnet)
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana airdrop 2 $(solana address) --url devnet || true
      
      - name: Build Anchor Program
        run: |
          # Set up all PATHs
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          export PATH="$HOME/.avm/bin:$PATH"
          export PATH="$HOME/.cargo/bin:$PATH"
          
          # Ensure we're using Anchor 0.32.1 BEFORE anything else
          avm use 0.32.1
          
          # Verify Anchor is available and correct version
          echo "Checking Anchor installation..."
          which anchor
          anchor --version
          
          cd ${{ github.workspace }}
          
          # Remove ALL Cargo.lock files AGAIN (in case they were regenerated)
          find . -name "Cargo.lock" -type f -delete
          rm -f Cargo.lock programs/*/Cargo.lock programs/clash-royale-escrow/Cargo.lock
          echo "Removed all Cargo.lock files before build"
          
          # Verify Anchor.toml specifies correct version
          echo "Checking Anchor.toml..."
          cat programs/clash-royale-escrow/Anchor.toml | grep -A 1 "anchor_version" || echo "No anchor_version found in Anchor.toml"
          
          # Configure Cargo to use lock file version 3 (compatible)
          # This prevents Cargo from creating version 4 lock files
          export CARGO_NET_OFFLINE=false
          
          # Build with Anchor - this will generate a fresh Cargo.lock
          anchor build
      
      - name: Verify Build Output
        run: |
          ls -lh target/deploy/*.so
          ls -lh target/deploy/*-keypair.json
      
      - name: Deploy to Devnet
        env:
          SOLANA_PRIVATE_KEY: ${{ secrets.SOLANA_PRIVATE_KEY }}
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          cd ${{ github.workspace }}
          
          # Set up keypair from secret if provided, otherwise use generated one
          if [ -n "$SOLANA_PRIVATE_KEY" ]; then
            echo "$SOLANA_PRIVATE_KEY" > ~/.config/solana/id.json
          fi
          
          # Deploy the program
          solana program deploy target/deploy/clash_royale_escrow.so \
            --url devnet \
            --program-id programs/clash-royale-escrow/target/deploy/clash_royale_escrow-keypair.json \
            --max-signatures 1
      
      - name: Verify Deployment
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana program show Boj5LmCSvrNMzJ9mdbTEf2vMZ1HnabZb2p3KHxyQgcDY --url devnet
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: program-artifacts
          path: |
            target/deploy/*.so
            target/idl/*.json
          retention-days: 30

