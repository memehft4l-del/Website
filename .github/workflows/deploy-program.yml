name: Build and Deploy Solana Program

on:
  push:
    branches: [ main ]
    paths:
      - 'programs/**'
      - 'Cargo.toml'
      - 'Anchor.toml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Remove Cargo.lock from programs subdirectories
        run: |
          # Only remove Cargo.lock from programs subdirectories (keep root)
          find programs -name "Cargo.lock" -type f -delete
          echo "✓ Removed Cargo.lock files from programs subdirectories"
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Verify Cargo version
        run: |
          cargo --version
          rustc --version
          # Ensure we have a Cargo version that supports lock file version 4
          CARGO_VERSION=$(cargo --version | awk '{print $2}')
          echo "Cargo version: $CARGO_VERSION"
      
      - name: Install Solana CLI
        run: |
          # For Solana 2.0+, use agave install instead of solana install
          # Install Solana 2.1.13 (supports lockfile version 4)
          sh -c "$(curl -sSfL https://release.anza.xyz/v2.1.13/install)"
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          
          # Update solana-install to ensure compatibility
          solana-install update || true
          
          # Verify installation
          solana --version
          solana-install --version
          echo "Solana CLI installed successfully"
      
      - name: Install Anchor
        run: |
          # Install avm (Anchor Version Manager) first
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          
          # Add cargo bin to PATH for avm
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          
          # Install Anchor 0.32.1 using avm
          avm install 0.32.1
          avm use 0.32.1
          
          # Add Anchor to PATH
          export PATH="$HOME/.avm/bin:$PATH"
          echo "$HOME/.avm/bin" >> $GITHUB_PATH
          
          # Verify installation and version
          anchor --version
          echo "Anchor version: $(anchor --version)"
          
          # Verify Rust version compatibility
          rustc --version
          echo "Rust version check complete"
      
      - name: Setup Solana CLI
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana config set --url devnet
          solana-keygen new --no-bip39-passphrase -o ~/.config/solana/id.json || true
      
      - name: Airdrop SOL (Devnet)
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana airdrop 2 $(solana address) --url devnet || true
      
      - name: Build Solana Program
        run: |
          # Setup Paths
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          export PATH="$HOME/.avm/bin:$PATH"
          export PATH="$HOME/.cargo/bin:$PATH"
          
          cd ${{ github.workspace }}
          
          # Verify Rust version meets requirements (Solana 2.1.13 needs rustc 1.79.0+)
          echo "Checking Rust version..."
          rustc --version
          RUST_VERSION=$(rustc --version | awk '{print $2}')
          echo "Rust version: $RUST_VERSION"
          
          # Verify Solana CLI is available
          echo "Checking Solana CLI..."
          solana --version
          cargo-build-sbf --version || echo "cargo-build-sbf not found, will use anchor build"
          
          # Verify Anchor.toml specifies correct version
          echo "Checking Anchor.toml..."
          cat programs/clash-royale-escrow/Anchor.toml | grep -A 1 "anchor_version" || echo "No anchor_version found in Anchor.toml"
          
          # Remove any existing Cargo.lock to force fresh resolution
          rm -f Cargo.lock
          find programs -name "Cargo.lock" -delete
          
          # Try building with cargo-build-sbf first (more reliable)
          # If that fails, fall back to anchor build
          echo "Attempting to build with cargo-build-sbf..."
          cd programs/clash-royale-escrow
          
          if command -v cargo-build-sbf &> /dev/null; then
            echo "Using cargo-build-sbf for direct Rust build..."
            cargo build-sbf --manifest-path Cargo.toml || {
              echo "cargo-build-sbf failed, trying anchor build..."
              cd ${{ github.workspace }}
              avm use 0.32.1
              anchor build
            }
          else
            echo "cargo-build-sbf not available, using anchor build..."
            cd ${{ github.workspace }}
            avm use 0.32.1
            anchor --version
            anchor build
          fi
          
          # Ensure we're back in workspace root
          cd ${{ github.workspace }}
          
          # Verify build output exists
          if [ -f "target/deploy/clash_royale_escrow.so" ]; then
            echo "✅ Build successful! Program binary found."
            ls -lh target/deploy/clash_royale_escrow.so
          else
            echo "❌ Build failed - no .so file found"
            exit 1
          fi
      
      - name: Verify Build Output
        run: |
          ls -lh target/deploy/*.so
          ls -lh target/deploy/*-keypair.json
      
      - name: Deploy to Devnet
        env:
          SOLANA_PRIVATE_KEY: ${{ secrets.SOLANA_PRIVATE_KEY }}
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          cd ${{ github.workspace }}
          
          # Set up keypair from secret if provided, otherwise use generated one
          if [ -n "$SOLANA_PRIVATE_KEY" ]; then
            echo "$SOLANA_PRIVATE_KEY" > ~/.config/solana/id.json
          fi
          
          # Deploy the program
          # Check if keypair exists, if not use the program ID directly
          if [ -f "programs/clash-royale-escrow/target/deploy/clash_royale_escrow-keypair.json" ]; then
            solana program deploy target/deploy/clash_royale_escrow.so \
              --url devnet \
              --program-id programs/clash-royale-escrow/target/deploy/clash_royale_escrow-keypair.json \
              --max-signatures 1
          else
            echo "Keypair not found, deploying with program ID..."
            solana program deploy target/deploy/clash_royale_escrow.so \
              --url devnet \
              --program-id CA4ADsMYjuCQMsGfHuxHzcn4s6VuiQCtT49MGCLANEvb \
              --max-signatures 1
          fi
      
      - name: Verify Deployment
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana program show CA4ADsMYjuCQMsGfHuxHzcn4s6VuiQCtT49MGCLANEvb --url devnet
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: program-artifacts
          path: |
            target/deploy/*.so
            target/idl/*.json
          retention-days: 30

